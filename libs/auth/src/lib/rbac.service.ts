
import { Injectable, Inject } from '@nestjs/common';
import { User, Task } from '@secure-task-manage-app-angular/data/entities';
import { UserRole } from '@secure-task-manage-app-angular/data/enums';
import { OrgScopeService } from './org-scope.service';

@Injectable()
export class RbacService {
    constructor(@Inject(OrgScopeService) private readonly orgScopeService: OrgScopeService) { }

    hasRequiredRole(userRole: UserRole, requiredRoles: UserRole[]): boolean {
        if (requiredRoles.includes(userRole)) return true;

        if (userRole === UserRole.OWNER) {
            if (requiredRoles.includes(UserRole.ADMIN) || requiredRoles.includes(UserRole.VIEWER)) return true;
        }

        if (userRole === UserRole.ADMIN) {
            if (requiredRoles.includes(UserRole.VIEWER)) return true;
        }

        return false;
    }

    canCreateTask(_user: User): boolean {
        // All roles allowed to create task in their own org
        // "organizationId must equal user.organizationId" is a data constraint check rather than permission boolean here
        // But boolean check is: Yes, they can create.
        return true;
    }

    async canReadTasks(_user: User): Promise<boolean> {
        // Logic handled in service query filtering usually, but as a check:
        return true;
    }

    // Actually, for Read/Update/Delete on specific task:

    async canUpdateTask(user: User, task: Task): Promise<boolean> {
        // Viewer -> only if createdBy === user.id
        if (user.role === UserRole.VIEWER) {
            return task.createdBy === user.id;
        }

        // Owner/Admin -> allowed if task org IN accessibleOrgIds
        const accessibleOrgs = await this.orgScopeService.getAccessibleOrganizationIds(user);
        return accessibleOrgs.includes(task.organizationId);
    }

    async canDeleteTask(user: User, task: Task): Promise<boolean> {
        // Viewer -> forbidden
        if (user.role === UserRole.VIEWER) {
            return false;
        }

        // Owner/Admin -> allowed if task org IN accessibleOrgIds
        const accessibleOrgs = await this.orgScopeService.getAccessibleOrganizationIds(user);
        return accessibleOrgs.includes(task.organizationId);
    }
}
